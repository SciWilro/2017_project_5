<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Florian Privé" />

<meta name="date" content="2017-10-21" />

<title>Analysis results in a consistent data structure</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-1.1/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-1.1/highlight.js"></script>
<link href="site_libs/font-awesome-4.5.0/css/font-awesome.min.css" rel="stylesheet" />

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs && document.readyState && document.readyState === "complete") {
   window.setTimeout(function() {
      hljs.initHighlighting();
   }, 0);
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>


</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->






<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">Genomic Data Analysis in R</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="about.html">
    <span class="fa fa-user"></span>
     
    About
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    <span class="fa fa-file"></span>
     
    Tutorials
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Pipelines</li>
    <li>
      <a href="all-in-R.html">Doing all your analysis in R</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Data Wrangling and Analysis</li>
    <li>
      <a href="eQTLanalysis.html">(Not finished) Simplified eQTL analysis in R</a>
    </li>
    <li>
      <a href="tidyverse-list-columns.html">Analysis results in a consistent data structure</a>
    </li>
    <li>
      <a href="memory-mapping.html">Genomic data analysis with large matrices in R</a>
    </li>
    <li class="divider"></li>
    <li class="dropdown-header">Data Vizualization</li>
    <li class="dropdown-header">Unsupervised clustering</li>
    <li class="divider"></li>
    <li class="dropdown-header">Reporting</li>
    <li class="dropdown-header">(Coming soon) Yisong's tutorial (rmarkdown)</li>
    <li class="dropdown-header">Integration of Genomic Analytic Results as a Multi-tab Excel Sheet with Package 'xlsx'</li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="http://www.hackseq.com/">hackseq</a>
</li>
<li>
  <a href="presentation/hackseq.html">Presentation</a>
</li>
<li>
  <a href="paper.html">Paper</a>
</li>
<li>
  <a href="https://github.com/hackseq/2017_project_5">
    <span class="fa fa-github"></span>
     
    GitHub
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Analysis results in a consistent data structure</h1>
<h4 class="author"><em>Florian Privé</em></h4>
<h4 class="date"><em>October 21, 2017</em></h4>

</div>


<p>How do you store results of an analysis?</p>
<p>When you have different parameters that are varying, when you compare many methods and when you want to keep all the results of an analysis, your code can become quite complex.</p>
<p>In this tutorial, we’ll make a comparison of machine learning methods for predicting disease based on small SNP data. We’ll show how to use the tidyverse set of packages to make the analysis easier by using consistent data structures and functional programming. We’ll use tibbles with <a href="http://r4ds.had.co.nz/many-models.html">list-columns</a>.</p>
<div id="a-simulation-made-easy" class="section level2">
<h2>A simulation made easy</h2>
<div id="data" class="section level3">
<h3>Data</h3>
<p>Let’s use some 1000 Genomes data from <a href="https://github.com/gabraham/flashpca/tree/master/HapMap3">Gad Abraham’s GitHub repository</a> which have been filtered and quality-controled.</p>
<pre class="r"><code>library(tidyverse)</code></pre>
<pre><code>## Loading tidyverse: ggplot2
## Loading tidyverse: tibble
## Loading tidyverse: tidyr
## Loading tidyverse: readr
## Loading tidyverse: purrr
## Loading tidyverse: dplyr</code></pre>
<pre><code>## Conflicts with tidy packages --------------------------------------------------------</code></pre>
<pre><code>## filter(): dplyr, stats
## lag():    dplyr, stats</code></pre>
<pre class="r"><code>tmpfile &lt;- tempfile()
base &lt;- paste0(
  &quot;https://github.com/gabraham/flashpca/raw/master/HapMap3/&quot;,
  &quot;1kg.ref.phase1_release_v3.20101123_thinned_autosomal_overlap&quot;)
exts &lt;- c(&quot;.bed&quot;, &quot;.bim&quot;, &quot;.fam&quot;)
map2_int(paste0(base, exts), paste0(tmpfile, exts), ~download.file(.x, .y))</code></pre>
<pre><code>## [1] 0 0 0</code></pre>
<pre class="r"><code>library(bigsnpr)</code></pre>
<pre><code>## Loading required package: bigstatsr</code></pre>
<pre class="r"><code>rdsfile &lt;- snp_readBed(paste0(tmpfile, &quot;.bed&quot;), tempfile())

bigsnp &lt;- snp_attach(rdsfile)
G &lt;- bigsnp$genotypes
obj.svd &lt;- snp_autoSVD(G, bigsnp$map$chromosome, bigsnp$map$physical.pos, ncores = 2)</code></pre>
<pre><code>## Phase of clumping at r2 &gt; 0.2.. keep 14079 SNPs.
## 
## Iteration 1:
## Computing SVD..
## 
## Converged!</code></pre>
<pre class="r"><code># Matrix of genotypes and first 10 PCs
X &lt;- cbind(G[], obj.svd$u)</code></pre>
</div>
<div id="methods-functions" class="section level3">
<h3>Methods’ functions</h3>
<pre class="r"><code>library(tidyverse)</code></pre>
<p>Each method’s function returns a tibble (data frame) with 4 columns:</p>
<ol style="list-style-type: decimal">
<li>the name of the method,</li>
<li>the predictive scores and true phenotypes for the test set, as a <a href="http://r4ds.had.co.nz/many-models.html">list-column</a>,</li>
<li>the timing of the main computations (in seconds),</li>
<li>the number of SNPs used for the prediction.</li>
</ol>
<pre class="r"><code>logit &lt;- function(X, y, ind.train, ind.test) {
  
  timing &lt;- system.time({
    train &lt;- glmnet::cv.glmnet(X[ind.train, ], y[ind.train], type.measure = &quot;auc&quot;, 
                               family = &quot;binomial&quot;, alpha = 0.5)
    preds &lt;- predict(train, X[ind.test, ])
  })[3]
  
  tibble(
    method = &quot;logit&quot;,
    eval = list(cbind(preds, y[ind.test])),
    timing = timing,
    nb.preds = sum(glmnet::coef.cv.glmnet(train) != 0)
  )
}</code></pre>
<pre class="r"><code>svm &lt;- function(X, y, ind.train, ind.test) {
  
  timing &lt;- system.time({
    train &lt;- LiblineaR::LiblineaR(X[ind.train, ], y[ind.train], type = 5)
    preds &lt;- predict(train, X[ind.test, ], decisionValues = TRUE)
  })[3]
  
  tibble(
    method = &quot;svm&quot;,
    eval = list(cbind(1 - preds$decisionValues[, 1], y[ind.test])),
    timing = timing,
    nb.preds = sum(train$W != 0)
  )
}</code></pre>
<pre class="r"><code>xgb &lt;- function(X, y, ind.train, ind.test) {
  
  timing &lt;- system.time({
    train &lt;- xgboost::xgboost(data = X[ind.train, ], label = y[ind.train],
                              nrounds = 10, max_depth = 3, eta = 1,
                              objective = &quot;binary:logistic&quot;, 
                              verbose = FALSE, save_period = NULL)
    preds &lt;- predict(train, X[ind.test, ])
  })[3]
  
  tibble(
    method = &quot;xgb&quot;,
    eval = list(cbind(preds, y[ind.test])),
    timing = timing,
    nb.preds = nrow(xgboost::xgb.importance(model = train))
  )
}</code></pre>
</div>
<div id="simulation-of-phenotypes" class="section level3">
<h3>Simulation of phenotypes</h3>
<pre class="r"><code>get_pheno &lt;- function(
  G,                                        ## matrix of genotypes
  h2,                                       ## heritability 
  M,                                        ## nbs of causal variants
  effects.dist = c(&quot;gaussian&quot;, &quot;laplace&quot;),  ## distribution of effects 
  K = 0.3                                   ## prevalence
) {
  
  effects.dist  &lt;- match.arg(effects.dist)
  
  set &lt;- sample(ncol(G), size = M)
  effects &lt;- `if`(effects.dist == &quot;gaussian&quot;, 
                  rnorm(M, sd = sqrt(h2 / M)),
                  rmutil::rlaplace(M, s = sqrt(h2 / (2*M))))
  
  y.simu &lt;- scale(G[, set]) %*% effects
  y.simu &lt;- y.simu / sd(y.simu) * sqrt(h2)
  stopifnot(all.equal(drop(var(y.simu)), h2))
  y.simu &lt;- y.simu + rnorm(nrow(G), sd = sqrt(1 - h2))
  # Liability Threshold Model (LTM)
  pheno &lt;- as.numeric(y.simu &gt; qnorm(1 - K))
}</code></pre>
</div>
<div id="simulations" class="section level3">
<h3>Simulations</h3>
<p>First, we use <code>expand.grid</code> to create a data frame with all possible combination of parameters we compare.</p>
<pre class="r"><code>results &lt;- expand.grid(
  M        = c(30, 3000), 
  dist     = c(&quot;gaussian&quot;, &quot;laplace&quot;), 
  num.simu = 1:10,
  stringsAsFactors = FALSE
) %&gt;% 
  as_tibble() %&gt;%
  print()</code></pre>
<pre><code>## # A tibble: 40 x 3
##        M     dist num.simu
##    &lt;dbl&gt;    &lt;chr&gt;    &lt;int&gt;
##  1    30 gaussian        1
##  2  3000 gaussian        1
##  3    30  laplace        1
##  4  3000  laplace        1
##  5    30 gaussian        2
##  6  3000 gaussian        2
##  7    30  laplace        2
##  8  3000  laplace        2
##  9    30 gaussian        3
## 10  3000 gaussian        3
## # ... with 30 more rows</code></pre>
<p>Then, we use package purrr to add a new column to the data frame with all the results. The main condition for a data frame is that each column has the same number of elements. So, by using lists, we can basically store any types of data in a data frame. For example, in column <code>&quot;eval&quot;</code> we store matrices, this is called a list-column. In the newly-created column <code>&quot;res&quot;</code>, we store data frames! We use tibbles instead of standard data frames because they print better.</p>
<pre class="r"><code>results[[&quot;res&quot;]] &lt;- pmap(results, function(M, dist, num.simu) {
  
  cat(&quot;.&quot;)
  
  y &lt;- get_pheno(X, 0.8, M, dist)
  
  n &lt;- nrow(X)
  ind.train &lt;- sort(sample(n, size = 500))
  ind.test &lt;- setdiff(1:n, ind.train)
  
  bind_rows(
    logit(X, y, ind.train, ind.test),
    svm(X, y, ind.train, ind.test),
    xgb(X, y, ind.train, ind.test)
  ) 
})</code></pre>
<pre><code>## ........................................</code></pre>
<pre class="r"><code>results</code></pre>
<pre><code>## # A tibble: 40 x 4
##        M     dist num.simu              res
##    &lt;dbl&gt;    &lt;chr&gt;    &lt;int&gt;           &lt;list&gt;
##  1    30 gaussian        1 &lt;tibble [3 x 4]&gt;
##  2  3000 gaussian        1 &lt;tibble [3 x 4]&gt;
##  3    30  laplace        1 &lt;tibble [3 x 4]&gt;
##  4  3000  laplace        1 &lt;tibble [3 x 4]&gt;
##  5    30 gaussian        2 &lt;tibble [3 x 4]&gt;
##  6  3000 gaussian        2 &lt;tibble [3 x 4]&gt;
##  7    30  laplace        2 &lt;tibble [3 x 4]&gt;
##  8  3000  laplace        2 &lt;tibble [3 x 4]&gt;
##  9    30 gaussian        3 &lt;tibble [3 x 4]&gt;
## 10  3000 gaussian        3 &lt;tibble [3 x 4]&gt;
## # ... with 30 more rows</code></pre>
</div>
<div id="results" class="section level3">
<h3>Results</h3>
<p>First, we use function <code>unnest</code> of package <code>tidyr</code> so that we have a tidier data frame. To learn more about <em>tidy data</em>, please refer to <a href="http://tidyr.tidyverse.org/articles/tidy-data.html">this vignette</a> and <a href="http://r4ds.had.co.nz/tidy-data.html">this book chapter</a>.</p>
<pre class="r"><code>(results &lt;- unnest(results, res))</code></pre>
<pre><code>## # A tibble: 120 x 7
##        M     dist num.simu method            eval timing nb.preds
##    &lt;dbl&gt;    &lt;chr&gt;    &lt;int&gt;  &lt;chr&gt;          &lt;list&gt;  &lt;dbl&gt;    &lt;int&gt;
##  1    30 gaussian        1  logit &lt;dbl [592 x 2]&gt; 20.200       19
##  2    30 gaussian        1    svm &lt;dbl [592 x 2]&gt;  2.017     1035
##  3    30 gaussian        1    xgb &lt;dbl [592 x 2]&gt;  1.771       67
##  4  3000 gaussian        1  logit &lt;dbl [592 x 2]&gt; 18.580       10
##  5  3000 gaussian        1    svm &lt;dbl [592 x 2]&gt;  1.707     1187
##  6  3000 gaussian        1    xgb &lt;dbl [592 x 2]&gt;  1.626       68
##  7    30  laplace        1  logit &lt;dbl [592 x 2]&gt; 15.834        9
##  8    30  laplace        1    svm &lt;dbl [592 x 2]&gt;  1.649     1091
##  9    30  laplace        1    xgb &lt;dbl [592 x 2]&gt;  1.322       64
## 10  3000  laplace        1  logit &lt;dbl [592 x 2]&gt; 16.811        3
## # ... with 110 more rows</code></pre>
<p>To compute the AUC (a measure of prediction accuracy), we use purrr again and specify the type of the output we want (<code>_dbl</code> for doubles). Here, we could use function mutate of package dplyr instead of standard accessor <code>[[</code>.</p>
<pre class="r"><code>results[[&quot;AUC&quot;]] &lt;- map_dbl(results[[&quot;eval&quot;]], ~bigstatsr::AUC(.x[, 1], .x[, 2]))
results</code></pre>
<pre><code>## # A tibble: 120 x 8
##        M     dist num.simu method            eval timing nb.preds       AUC
##    &lt;dbl&gt;    &lt;chr&gt;    &lt;int&gt;  &lt;chr&gt;          &lt;list&gt;  &lt;dbl&gt;    &lt;int&gt;     &lt;dbl&gt;
##  1    30 gaussian        1  logit &lt;dbl [592 x 2]&gt; 20.200       19 0.8563973
##  2    30 gaussian        1    svm &lt;dbl [592 x 2]&gt;  2.017     1035 0.6828651
##  3    30 gaussian        1    xgb &lt;dbl [592 x 2]&gt;  1.771       67 0.6250210
##  4  3000 gaussian        1  logit &lt;dbl [592 x 2]&gt; 18.580       10 0.7140415
##  5  3000 gaussian        1    svm &lt;dbl [592 x 2]&gt;  1.707     1187 0.6539634
##  6  3000 gaussian        1    xgb &lt;dbl [592 x 2]&gt;  1.626       68 0.5577844
##  7    30  laplace        1  logit &lt;dbl [592 x 2]&gt; 15.834        9 0.8441696
##  8    30  laplace        1    svm &lt;dbl [592 x 2]&gt;  1.649     1091 0.7119032
##  9    30  laplace        1    xgb &lt;dbl [592 x 2]&gt;  1.322       64 0.7027520
## 10  3000  laplace        1  logit &lt;dbl [592 x 2]&gt; 16.811        3 0.5090266
## # ... with 110 more rows</code></pre>
<p>Now, let’s get some summaries of the results with package dplyr.</p>
<pre class="r"><code>results %&gt;%
  group_by(M, dist, method) %&gt;%
  summarise_at(c(&quot;timing&quot;, &quot;nb.preds&quot;, &quot;AUC&quot;), mean)</code></pre>
<pre><code>## # A tibble: 12 x 6
## # Groups:   M, dist [?]
##        M     dist method  timing nb.preds       AUC
##    &lt;dbl&gt;    &lt;chr&gt;  &lt;chr&gt;   &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
##  1    30 gaussian  logit 16.7186     24.4 0.8047693
##  2    30 gaussian    svm  1.6179   1083.6 0.5368827
##  3    30 gaussian    xgb  1.3670     65.3 0.6417739
##  4    30  laplace  logit 15.9369     10.7 0.8460125
##  5    30  laplace    svm  1.6222   1138.2 0.6764060
##  6    30  laplace    xgb  1.3339     63.1 0.6934731
##  7  3000 gaussian  logit 17.2041      7.1 0.5594812
##  8  3000 gaussian    svm  1.5931   1166.1 0.5188196
##  9  3000 gaussian    xgb  1.3196     67.8 0.5302460
## 10  3000  laplace  logit 17.0658      4.1 0.5318777
## 11  3000  laplace    svm  1.6391   1170.6 0.5361078
## 12  3000  laplace    xgb  1.3428     68.3 0.5151852</code></pre>
</div>
<div id="visualise-results" class="section level3">
<h3>Visualise results</h3>
<p>Finally, let’s use package ggplot2, also part of the tidyverse, to plot the results.</p>
<pre class="r"><code># Wrapper to use my own theme
myggplot &lt;- function(...) bigstatsr:::MY_THEME(ggplot(...))</code></pre>
<pre class="r"><code>myggplot(results) + 
  geom_boxplot(aes(method, timing)) +
  scale_y_continuous(breaks = seq(0, 20, 2)) +
  facet_grid(M ~ dist) +
  theme(strip.text.x = element_text(size = rel(2)),
        strip.text.y = element_text(size = rel(2))) +
  ggtitle(&quot;Timings&quot;)</code></pre>
<p><img src="tidyverse-list-columns_files/figure-html/unnamed-chunk-15-1.png" width="75%" style="display: block; margin: auto;" /></p>
<pre class="r"><code>myggplot(results) + 
  geom_hline(yintercept = 0.5, color = &quot;red&quot;, linetype = 2) + 
  geom_boxplot(aes(method, AUC)) +
  scale_y_continuous(breaks = 0:10 / 10) +
  facet_grid(M ~ dist) +
  theme(strip.text.x = element_text(size = rel(2)),
        strip.text.y = element_text(size = rel(2))) +
  ggtitle(&quot;Predictive performance&quot;)</code></pre>
<p><img src="tidyverse-list-columns_files/figure-html/unnamed-chunk-16-1.png" width="75%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="conclusion" class="section level2">
<h2>Conclusion</h2>
<p>The main point of using tibbles to store results is that you have the inputs, raw outputs and transformed outputs in the same data structure. Moreover, this data structure contains information that are easy to manipulate and visualize. Finally, note that we didn’t use a single loop in the whole method comparison.</p>
<p>The tidyverse set of packages is very convenient and consistent. You can learn more by reading <a href="http://r4ds.had.co.nz/">book R for Data Science</a>, freely available online.</p>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
